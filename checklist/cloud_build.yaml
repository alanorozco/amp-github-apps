steps:
  # The first two steps are required to identify and inject un-redacted secrets.
  - name: gcr.io/cloud-builders/npm
    args:
      - install
      - yaml
  - name: gcr.io/cloud-builders/npm
    args:
      - run
      - replace-secrets
      - --
      - checklist
    secretEnv:
      - PRIVATE_KEY
      - WEBHOOK_SECRET

  # Compile the app from Typescript into dist/.
  - name: gcr.io/cloud-builders/npm
    dir: checklist
    args:
      - install
  - name: gcr.io/cloud-builders/npm
    dir: checklist
    args:
      - run
      - build

  # Copy over the environment and package file.
  - name: ubuntu
    dir: checklist
    args:
      - cp
      - .env
      - dist/
  - name: ubuntu
    dir: checklist
    args:
      - cp
      - package.json
      - dist/

  # Deploy the app.
  - name: gcr.io/cloud-builders/gcloud
    dir: checklist
    args:
      - functions
      - deploy
      - --source
      - dist/
      - checklist-bot
      - --entry-point
      - probot

# These secrets are the base64-encoded form of encrypted secret values. They are
# automatically decrypted and added to the `.env` environment at build time.
secrets:
  - kmsKeyName: projects/amp-checklist-bot/locations/global/keyRings/amp-github-apps-keyring/cryptoKeys/app-env-key
    secretEnv:
      PRIVATE_KEY: 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
      WEBHOOK_SECRET: CiQAawD9BcKvSg6gq0ep1IeZlqqtVhuwwwaaHAqgXj7HZIuFn6QSUQC0wIdgflRG7hpTWBtaZcdyCPplQDZmzrxB8dJAjlIU3ZfEaCmJgUizHm3PCIwNVrn0M4arj7IUFfsScr/kdA9EdSgVjRsJgSPguYnY8C7SBw==
